generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  customer
  pro
  admin
}

enum JobStatus {
  draft
  open
  offered
  accepted
  in_progress
  completed
  canceled
  disputed
}

enum AcceptanceStatus {
  pending_customer
  confirmed
  declined
  expired
}

enum PaymentStatus {
  authorized
  captured
  refunded
  disputed
}

model User {
  id           String   @id @default(uuid())
  auth0Sub     String?  @unique
  role         Role
  name         String
  email        String?  @unique
  phone        String?  @unique
  photoUrl     String?
  ratingAvg    Float?
  ratingCount  Int?
  createdAt    DateTime @default(now())

  proProfile   ProProfile?
  jobs         Job[]     @relation("CustomerJobs")
  messages     Message[]
  reviewsLeft  Review[]  @relation("ReviewsLeft")
  reviewsRecv  Review[]  @relation("ReviewsRecv")
  disputes     Dispute[]


  JobAcceptance JobAcceptance[]
}


model ProProfile {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id])
  skills                String[]
  bio                   String?
  hourlyRate            Float?
  minJobPrice           Float?
  maxDistanceKm         Float    @default(15)
  serviceAreaGeojson    Json?
  portfolioMedia        String[]
  verificationStatus    String   @default("unverified")
  payoutAccountId       String?
  availableCalendarJson Json?
}

model Category {
  id          String  @id @default(uuid())
  name        String  @unique
  icon        String?
  description String?
  jobs        Job[]
}

model Job {
  id                String    @id @default(uuid())
  customerId        String
  customer          User      @relation("CustomerJobs", fields: [customerId], references: [id])
  categoryId        String
  category          Category  @relation(fields: [categoryId], references: [id])
  title             String
  description       String
  photos            String[]
  addressLine       String
  lat               Float
  lng               Float
  scheduledStartAt  DateTime
  timeWindowMins    Int
  budgetFixedCents  Int
  status            JobStatus @default(open)
  paymentIntentId   String?
  createdAt         DateTime  @default(now())

  acceptances       JobAcceptance[]
  messages          Message[]
  payments          Payment[]
  reviews           Review[]
  disputes          Dispute[]
}

model JobAcceptance {
  id         String           @id @default(uuid())
  jobId      String
  job        Job              @relation(fields: [jobId], references: [id])
  proId      String
  pro        User             @relation(fields: [proId], references: [id])
  acceptedAt DateTime
  expiresAt  DateTime
  status     AcceptanceStatus
}

model Message {
  id          String   @id @default(uuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id])
  fromUserId  String
  fromUser    User     @relation(fields: [fromUserId], references: [id])
  body        String
  media       String[]
  createdAt   DateTime @default(now())
  system      Boolean  @default(false)
}

model Payment {
  id                    String        @id @default(uuid())
  jobId                 String
  job                   Job           @relation(fields: [jobId], references: [id])
  amountCents           Int
  stripePaymentIntentId String
  stripeTransferId      String?
  status                PaymentStatus
}

model Review {
  id              String   @id @default(uuid())
  jobId           String
  job             Job      @relation(fields: [jobId], references: [id])
  reviewerUserId  String
  reviewer        User     @relation("ReviewsLeft", fields: [reviewerUserId], references: [id])
  revieweeUserId  String
  reviewee        User     @relation("ReviewsRecv", fields: [revieweeUserId], references: [id])
  rating          Int
  comment         String?
  createdAt       DateTime @default(now())
}

model Dispute {
  id              String   @id @default(uuid())
  jobId           String
  job             Job      @relation(fields: [jobId], references: [id])
  openedByUserId  String
  openedBy        User     @relation(fields: [openedByUserId], references: [id])
  reasonCode      String
  description     String
  evidenceMedia   String[]
  status          String
  resolution      String?
}
